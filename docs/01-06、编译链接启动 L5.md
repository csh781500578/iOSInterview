# 编译&链接过程
这个过程中隐藏了预处理、编译、汇编和链接4个过程。

![image](https://note.youdao.com/yws/api/personal/file/88C5E8CFE3A64A369FECCD87297414D3?method=download&shareKey=9884a15dc8dc7604c7f7c6baf735c274)

## 预处理
处理macro 宏， import 头文件及其他的预编译指令（均以"#"开头的文件），产生.i文件。规则如下：
- "#define"删除并展开对应宏定义。
- 处理所有的条件预编译指令。如#if/#ifdef/#else/#endif。
- "#include/#import"包含的文件递归插入到此处。
- 删除所有的注释"//或/**/"。
- 添加行号和文件名标识。如“# 1 "main.m"”,编译调试会用到。

## 编译
编译就是把上面得到的.i文件进行：词法分析、语法分析、静态分析、优化生成相应的汇编代码，得到.s文件。
### 词法分析
将源代码的字符序列分割成一个个token（关键字、标识符、字面量、特殊符号），比如把标识符放到符号表（静态链接那篇，重点讲符号表）。

### 语法分析
生成抽象语法树 AST，此时运算符号的优先级确定了；有些符号具有多重含义也确定了，比如“*”是乘号还是对指针取内容；表达式不合法、括号不匹配等，都会报错。

### 静态分析
分析类型声明和匹配问题。比如整型和字符串相加，肯定会报错。

### 中间语言生成
CodeGen根据AST自顶向下遍历逐步翻译成 LLVM IR，并且在编译期就可以确定的表达式进行优化，比如代码里t1=2+6，可以优化t1=8。（假如开启了bitcode）

### 目标代码生成与优化
根据中间语言生成依赖具体机器的汇编语言。并优化汇编语言。这个过程中，假如有变量且定义在同一个编译单元里，那给这个变量分配空间，确定变量的地址。假如变量或者函数不定义在这个编译单元，得链接时候，才能确定地址。

## 汇编
汇编就是把上面得到的.s文件里的汇编指令一一翻译成机器指令。得到.o文件，也就是目标文件，后面会重点讲的Mach-O文件。

## 链接
链接就是把目标文件（一个或多个）和需要的库（静态库/动态库）链接成可执行文件。

# iOS的编译器
iOS现在采用了LLVM作为编译器。
- LLVM采用三相设计，前端Clang负责解析，验证和诊断输入代码中的错误，然后将解析的代码转换为LLVM IR，后端LLVM编译把IR通过一系列改进代码的分析和优化过程提供，然后被发送到代码生成器以生成本机机器代码。

# iOS程序-详细编译过程
## 
- 1.写入辅助文件：将项目的文件结构对应表、将要执行的脚本、项目依赖库的文件结构对应表写成文件，方便后面使用；并且创建一个 .app 包，后面编译后的文件都会被放入包中；
- 2.运行预设脚本：Cocoapods 会预设一些脚本，当然你也可以自己预设一些脚本来运行。这些脚本都在 Build Phases中可以看到；
- 3.编译文件：针对每一个文件进行编译，生成可执行文件 Mach-O，这过程 LLVM 的完整流程，前端、优化器、后端；
- 4.链接文件：将项目中的多个可执行文件合并成一个文件；
- 5.拷贝资源文件：将项目中的资源文件拷贝到目标包；
- 6.编译 storyboard 文件：storyboard 文件也是会被编译的；
- 7.链接 storyboard 文件：将编译后的 storyboard 文件链接成一个文件；
- 8.编译 Asset 文件：我们的图片如果使用 Assets.xcassets 来管理图片，那么这些图片将会被编译成机器码，除了 icon 和 launchImage；
- 9.运行 Cocoapods 脚本：将在编译项目之前已经编译好的依赖库和相关资源拷贝到包中。
- 10.生成 .app 包
- 11.将 Swift 标准库拷贝到包中
- 12.对包进行签名
- 13.完成打包

## 戴铭总结
- 编译信息写入辅助文件，创建文件架构 .app 文件
- 处理文件打包信息
- 执行 CocoaPod 编译前脚本，checkPods Manifest.lock
- 编译.m文件，使用 CompileC 和 clang 命令
- 链接需要的 Framework
- 编译 xib
- 拷贝 xib ，资源文件
- 编译 ImageAssets
- 处理 info.plist
- 执行 CocoaPod 脚本
- 拷贝标准库
- 创建 .app 文件和签名

# Mach-O
## 什么是Mach-O文件？
Mach-O 文件是 iOS 和 OS 操作系统系统支持的可执行文件格式。
- 他是源代码编译得到的文件，包含机器指令、数据，还有链接时候需要的一些信息，比如符号表、调试信息、字符串等。
- 他由Header（头部信息）、Load Commands（加载命令）、Data（数据段）三部分组成。

## 胖二进制格式
通用二进制格式就是多种架（比如arm64和x86）构的Mach-O文件“打包”在一起，所以通用二进制格式，更多被叫做胖二进制格式。

# 资料
[深入剖析 iOS 编译 Clang / LLVM](https://ming1016.github.io/2017/03/01/deeply-analyse-llvm/#%E8%B5%84%E6%96%99%E7%BD%91%E5%9D%80)

[链接器：符号是怎么绑定到地址上的？](https://time.geekbang.org/column/article/86840)

[iOS程序员的自我修养](https://juejin.cn/post/6844903912143585288)

[iOS编译链接原理](https://www.jianshu.com/p/b62b891c5d18)

[iOS程序员的自我修养-编译、链接过程（一）
](https://juejin.cn/post/6844903912147795982)

[iOS开发你不知道的事-编译&链接](https://juejin.cn/post/6844903841842872327)

[iOS链接原理解析与应用实践](https://mp.weixin.qq.com/s/_3WXnDolNICs2euoJph44A)

[乐少-点击 Run 之后发生了什么？](https://www.jianshu.com/p/d5cf01424e92)

[iOS App从点击到启动](https://www.jianshu.com/p/231b1cebf477)